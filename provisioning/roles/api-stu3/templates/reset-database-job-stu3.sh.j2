#!/bin/bash

DATE=$(date '+%Y-%m-%d')
REMOVE_DATE=$(date --date="7 day ago" +%Y-%m-%d)
ERROR=1
CONTINUE_ON_ERROR=false
OUTPUT_FOLDER="{{user_jobs_output_home}}/$DATE"
REMOVE_OUTPUT_FOLDER="{{user_jobs_output_home}}/$REMOVE_DATE"

function handleLastError {
  echo $1
  if [ ! $CONTINUE_ON_ERROR ]
  then
    exit $ERROR
  fi
}

# clear out prior executions for this date
echo "Removing output folder $OUTPUT_FOLDER"
rm -rf $OUTPUT_FOLDER

# clear out folders that are old
echo "Removing output folder $REMOVE_OUTPUT_FOLDER"
rm -rf $REMOVE_OUTPUT_FOLDER

# make sure folders exist
echo "Creating output folder $OUTPUT_FOLDER"
mkdir -p $OUTPUT_FOLDER

# restore to the baseline snapshot
source {{user_scripts_home}}/restore-baseline-snapshot-stu3.sh .

if [ $? -ne 0 ]
then
    handleLastError "Failed to restore the baseline snapshot"
fi

# restart the api-dstu2 server (to clear out the hibernate sequence caching
sudo service api-dstu2-server restart

# wait for a few minutes
sleep 2m

# process the custom sample data
source {{user_scripts_home}}/process-custom-sample-data-dstu2.sh .

if [ $? -ne 0 ]
then
    handleLastError "Failed to process custom sample data"
fi

echo "reset-database-job-stu3.sh completed successfully!"
